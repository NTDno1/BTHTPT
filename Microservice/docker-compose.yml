version: '3.8'

services:
  # PostgreSQL và MongoDB đang sử dụng từ server external (47.130.33.106)
  # Không cần chạy trong Docker nữa
  
  # RabbitMQ - Sử dụng từ server external
  # Nếu muốn chạy local, uncomment phần dưới:
  # rabbitmq:
  #   image: rabbitmq:3-management
  #   container_name: microservice-rabbitmq
  #   ports:
  #     - "5672:5672"
  #     - "15672:15672"
  #   environment:
  #     - RABBITMQ_DEFAULT_USER=guest
  #     - RABBITMQ_DEFAULT_PASS=guest
  #   volumes:
  #     - rabbitmq_data:/var/lib/rabbitmq
  #   networks:
  #     - microservice-network
  #   healthcheck:
  #     test: rabbitmq-diagnostics -q ping
  #     interval: 10s
  #     timeout: 3s
  #     retries: 5

  # User Service - Instance 1 (Load Balanced)
  user-service-1:
    build:
      context: .
      dockerfile: Microservice.Services.UserService/Dockerfile
    container_name: microservice-user-service-1
    ports:
      - "5001:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__PostgreSQL=Host=47.130.33.106;Port=5432;Database=userservice_db;Username=postgres;Password=123456
      - ConnectionStrings__DefaultConnection=Host=47.130.33.106;Port=5432;Database=userservice_db;Username=postgres;Password=123456
      - MongoDb__ConnectionString=mongodb+srv://datt19112001_db_user:1@mongodbdatnt.bc8xywz.mongodb.net/?retryWrites=true&w=majority
      - MongoDb__Database=microservice_users
      - MongoDb__Collection=user_logs
    networks:
      - microservice-network
    restart: unless-stopped

  # User Service - Instance 2 (Load Balanced)
  user-service-2:
    build:
      context: .
      dockerfile: Microservice.Services.UserService/Dockerfile
    container_name: microservice-user-service-2
    ports:
      - "5004:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__PostgreSQL=Host=47.130.33.106;Port=5432;Database=userservice_db;Username=postgres;Password=123456
      - ConnectionStrings__DefaultConnection=Host=47.130.33.106;Port=5432;Database=userservice_db;Username=postgres;Password=123456
      - MongoDb__ConnectionString=mongodb+srv://datt19112001_db_user:1@mongodbdatnt.bc8xywz.mongodb.net/?retryWrites=true&w=majority
      - MongoDb__Database=microservice_users
      - MongoDb__Collection=user_logs
    networks:
      - microservice-network
    restart: unless-stopped

  # User Service Load Balancer (Nginx) - REMOVED
  # Không cần thiết vì đã dùng RabbitMQ load balancing tự động
  # user-service-lb:
  #   image: nginx:alpine
  #   container_name: microservice-user-service-lb
  #   ports:
  #     - "5005:80"
  #   volumes:
  #     - ./nginx-lb/user-service-lb.conf:/etc/nginx/conf.d/default.conf:ro
  #   depends_on:
  #     - user-service-1
  #     - user-service-2
  #   networks:
  #     - microservice-network
  #   restart: unless-stopped

  # Product Service - Instance 1 (Load Balanced)
  product-service-1:
    build:
      context: .
      dockerfile: Microservice.Services.ProductService/Dockerfile
    container_name: microservice-product-service-1
    ports:
      - "5002:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__PostgreSQL=Host=47.130.33.106;Port=5432;Database=productservice_db;Username=postgres;Password=123456
      - ConnectionStrings__DefaultConnection=Host=47.130.33.106;Port=5432;Database=productservice_db;Username=postgres;Password=123456
      - MongoDb__ConnectionString=mongodb+srv://datt19112001_db_user:1@mongodbdatnt.bc8xywz.mongodb.net/?retryWrites=true&w=majority
      - MongoDb__Database=microservice_products
      - MongoDb__Collection=product_logs
    networks:
      - microservice-network
    restart: unless-stopped

  # Product Service - Instance 2 (Load Balanced)
  product-service-2:
    build:
      context: .
      dockerfile: Microservice.Services.ProductService/Dockerfile
    container_name: microservice-product-service-2
    ports:
      - "5006:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__PostgreSQL=Host=47.130.33.106;Port=5432;Database=productservice_db;Username=postgres;Password=123456
      - ConnectionStrings__DefaultConnection=Host=47.130.33.106;Port=5432;Database=productservice_db;Username=postgres;Password=123456
      - MongoDb__ConnectionString=mongodb+srv://datt19112001_db_user:1@mongodbdatnt.bc8xywz.mongodb.net/?retryWrites=true&w=majority
      - MongoDb__Database=microservice_products
      - MongoDb__Collection=product_logs
    networks:
      - microservice-network
    restart: unless-stopped

  # Order Service - Instance 1 (Load Balanced)
  order-service-1:
    build:
      context: .
      dockerfile: Microservice.Services.OrderService/Dockerfile
    container_name: microservice-order-service-1
    ports:
      - "5003:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__PostgreSQL=Host=47.130.33.106;Port=5432;Database=orderservice_db;Username=postgres;Password=123456
      - ConnectionStrings__DefaultConnection=Host=47.130.33.106;Port=5432;Database=orderservice_db;Username=postgres;Password=123456
      - MongoDb__ConnectionString=mongodb+srv://datt19112001_db_user:1@mongodbdatnt.bc8xywz.mongodb.net/?retryWrites=true&w=majority
      - MongoDb__Database=microservice_orders
      - MongoDb__Collection=order_events
      - RabbitMQ__HostName=47.130.33.106
      - RabbitMQ__Port=5672
      - RabbitMQ__UserName=guest
      - RabbitMQ__Password=guest
      # Order Service gọi Product Service và User Service qua RabbitMQ queue (load balanced tự động)
      # Hoặc có thể dùng HTTP trực tiếp nếu cần
      # - ServiceUrls__ProductService=http://product-service-1:8080
      # - ServiceUrls__UserService=http://user-service-1:8080
    networks:
      - microservice-network
    restart: unless-stopped

  # Order Service - Instance 2 (Load Balanced)
  order-service-2:
    build:
      context: .
      dockerfile: Microservice.Services.OrderService/Dockerfile
    container_name: microservice-order-service-2
    ports:
      - "5007:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__PostgreSQL=Host=47.130.33.106;Port=5432;Database=orderservice_db;Username=postgres;Password=123456
      - ConnectionStrings__DefaultConnection=Host=47.130.33.106;Port=5432;Database=orderservice_db;Username=postgres;Password=123456
      - MongoDb__ConnectionString=mongodb+srv://datt19112001_db_user:1@mongodbdatnt.bc8xywz.mongodb.net/?retryWrites=true&w=majority
      - MongoDb__Database=microservice_orders
      - MongoDb__Collection=order_events
      - RabbitMQ__HostName=47.130.33.106
      - RabbitMQ__Port=5672
      - RabbitMQ__UserName=guest
      - RabbitMQ__Password=guest
      # Order Service gọi Product Service và User Service qua RabbitMQ queue (load balanced tự động)
      # Hoặc có thể dùng HTTP trực tiếp nếu cần
      # - ServiceUrls__ProductService=http://product-service-1:8080
      # - ServiceUrls__UserService=http://user-service-1:8080
    networks:
      - microservice-network
    restart: unless-stopped

  # API Gateway (Ocelot) - DISABLED - Chỉ sử dụng RabbitMQ Gateway
  # api-gateway:
  #   build:
  #     context: .
  #     dockerfile: Microservice.ApiGateway/Dockerfile
  #   container_name: microservice-api-gateway
  #   ports:
  #     - "5000:8080"
  #   environment:
  #     - ASPNETCORE_ENVIRONMENT=Development
  #     - ASPNETCORE_URLS=http://+:8080
  #   depends_on:
  #     - user-service-1
  #     - user-service-2
  #     - product-service
  #     - order-service
  #   networks:
  #     - microservice-network

  # API Gateway RabbitMQ - PRIMARY GATEWAY
  api-gateway-rabbitmq:
    build:
      context: .
      dockerfile: Microservice.ApiGateway.RabbitMQ/Dockerfile
    container_name: microservice-api-gateway-rabbitmq
    ports:
      - "5010:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - RabbitMQ__HostName=47.130.33.106
      - RabbitMQ__Port=5672
      - RabbitMQ__UserName=guest
      - RabbitMQ__Password=guest
    depends_on:
      - user-service-1
      - user-service-2
      - product-service-1
      - product-service-2
      - order-service-1
      - order-service-2
    networks:
      - microservice-network

  # Frontend (Angular)
  frontend:
    build:
      context: ./Frontend
      dockerfile: Dockerfile
    container_name: microservice-frontend
    ports:
      - "4200:80"
    environment:
      # API URL - trỏ đến API Gateway RabbitMQ (PRIMARY) - Localhost for testing
      - API_URL=http://103.82.39.10:5010/api
      # - API_URL=http://localhost:5010/api
    depends_on:
      - api-gateway-rabbitmq
    networks:
      - microservice-network
    restart: unless-stopped

networks:
  microservice-network:
    driver: bridge

